# 残業代計算仕様書

## 概要

本仕様書は、勤怠管理システムにおける残業代の計算ルールを定義します。
残業代の計算は、従業員の雇用形態（正社員/パート）と時間帯、曜日によって異なります。

**重要**: 残業代の計算は全てAPI側で実施します。クライアント側で計算することで生じる時刻の誤差を防ぐためです。

---

## 1. 基本方針

### 1.1 残業代計算の対象

- **正社員**: 所定労働時間（7.5時間/日）を超えた時間のみを残業として計算
- **パート**: 残業判定なし（実労働時間 × 基本給（時給））

### 1.2 所定労働時間の定義

- **正社員**: 
  - 所定時間: `09:00-18:00`（内休憩90分）
  - 実労働時間: 7.5時間/日
  - 残業単価計算: `(基本給(月給) + includeInOvertime=trueの手当金額合計) ÷ 20.5 ÷ 7.5`
- **パート**: 
  - 所定労働時間: 個人ごとに異なる（従業員マスタに保存）
  - 基本給: 時給
  - 残業判定: なし（実労働時間 × 時給）

### 1.3 日付の扱い

- **日付変更時刻**: `05:00`
- `04:59`まで: 前日として扱う
- `05:00`から: 当日として扱う
- `05:00`で自動的に退勤扱い（システム処理）

---

## 2. 時間帯の定義

### 2.1 時間帯の区分

時間帯は以下のように定義されます（境界値は開始時刻を含み、終了時刻を含まない `[開始時刻, 終了時刻)`）。

| 時間帯 | 平日 | 土曜日 | 日曜日 |
|--------|------|--------|--------|
| `05:00-08:44` | 1.25倍 | 1.25倍 | 1.50倍 |
| `08:45-18:15` | 1.00倍（通常単価） | 1.25倍 | 1.50倍 |
| `18:16-21:59` | 1.25倍 | 1.25倍 | 1.50倍 |
| `22:00-04:59` | 1.50倍（深夜） | 1.50倍（深夜） | 1.50倍（深夜） |

### 2.2 境界値の定義

- `05:00-08:44`: `05:00:00` から `08:44:59.999` まで
- `08:45-18:15`: `08:45:00` から `18:15:59.999` まで
- `18:16-21:59`: `18:16:00` から `21:59:59.999` まで
- `22:00-04:59`: `22:00:00` から `04:59:59.999` まで（日をまたぐ）

### 2.3 通常時間帯の扱い

`08:45-18:15`の時間帯は、正社員の所定労働時間として扱われます。
この時間帯は通常単価（1.00倍）として扱われ、残業判定の対象外となります。

---

## 3. 残業単価の計算

### 3.1 正社員の残業単価

```
残業単価 = (基本給(月給) + includeInOvertime=trueの手当金額合計) ÷ 20.5 ÷ 7.5
```

- **基本給**: 従業員マスタの `baseSalary`（月給）
- **手当金額**: 手当マスタの `includeInOvertime` が `true` の手当のみ含める
- **20.5**: 平均稼働日数/月
- **7.5**: 所定稼働時間/日（時間単位）

### 3.2 パートの基本給

```
基本給 = baseSalary（時給）
```

パートの場合は残業判定を行わず、実労働時間 × 基本給（時給）で計算します。

---

## 4. 残業代の計算

### 4.1 正社員の残業代計算

1. **所定労働時間の超過時間を計算**
   - 実労働時間 = 出勤時刻から退勤時刻までの時間 - 休憩時間
   - 残業時間 = 実労働時間 - 7.5時間（所定労働時間）

2. **残業時間を時間帯ごとに分割**
   - 複数の時間帯にまたがる場合は、時間帯ごとに分けて計算
   - 例: `18:10-19:10`（60分）の場合
     - `18:10-18:15`（5分）: 通常時間帯（残業対象外）
     - `18:16-19:10`（54分）: `18:16-21:59`時間帯（1.25倍）

3. **時間帯ごとの残業代を計算**
   ```
   時間帯別残業代 = 残業単価 × 単価率 × 稼働時間（分）
   ```

4. **合計残業代を計算**
   ```
   合計残業代 = Σ(時間帯別残業代)
   ```

5. **端数処理**
   - 金額端数: 全て切り上げ（1円単位）

### 4.2 パートの給与計算

```
給与 = 基本給(時給) × 実労働時間（時間単位）
```

- 残業判定なし
- 時間帯による単価率の適用なし
- 端数処理: 金額端数は全て切り上げ

---

## 5. 休憩時間の扱い

### 5.1 基本休憩時間

従業員登録・更新時に設定される基本休憩時間：
- **30分**: `15:00-15:30`
- **60分**: `12:00-13:00`
- **90分**: `12:00-13:00`、`15:00-15:30`

### 5.2 休憩時間の計算

- 休憩時間は残業時間に含めない
- 実労働時間 = 出勤時刻から退勤時刻までの時間 - 休憩時間
- 実際の休憩時間が基本休憩時間と異なる場合: 勤怠修正で対応

---

## 6. 曜日・祝日の判定

### 6.1 曜日の判定

- 曜日の判定は、勤務日の曜日を使用
- 祝日は曜日で判定（祝日は稼働日として扱う）
- 日付変更時刻（`05:00`）での日付判定に注意

### 6.2 日をまたぐ時間帯（22:00-04:59）の扱い

- `22:00-04:59`の時間帯は、開始日の時間帯として扱う
- 例: `2025-12-15 23:00` から `2025-12-16 03:00` は `2025-12-15`（月曜日）の時間帯として扱う
- 曜日判定は開始日の曜日を使用

---

## 7. 計算例

### 7.1 正社員の計算例

**前提条件**:
- 基本給: 300,000円/月
- `includeInOvertime=true`の手当合計: 20,000円
- 勤務日: 2025-12-15（月曜日）
- 出勤時刻: `09:00`
- 退勤時刻: `20:30`
- 休憩時間: 90分

**計算**:

1. **残業単価の計算**
   ```
   残業単価 = (300,000 + 20,000) ÷ 20.5 ÷ 7.5
            = 320,000 ÷ 20.5 ÷ 7.5
            = 15,609.76... → 15,610円/時間（切り上げ）
   ```

2. **実労働時間の計算**
   ```
   実労働時間 = 09:00 から 20:30 まで = 11時間30分 = 690分
   休憩時間 = 90分
   実労働時間（休憩除く）= 690 - 90 = 600分 = 10時間
   ```

3. **残業時間の計算**
   ```
   所定労働時間 = 7.5時間 = 450分
   残業時間 = 600 - 450 = 150分
   ```

4. **時間帯ごとの分割**
   - `18:00-18:15`（15分）: 通常時間帯（残業対象外）
   - `18:16-20:30`（134分）: `18:16-21:59`時間帯（1.25倍）

5. **残業代の計算**
   ```
   時間帯別残業代 = 15,610 × 1.25 × (134/60)
                  = 15,610 × 1.25 × 2.233...
                  = 43,541.67... → 43,542円（切り上げ）
   ```

### 7.2 パートの計算例

**前提条件**:
- 基本給: 1,200円/時
- 勤務日: 2025-12-15（月曜日）
- 出勤時刻: `10:00`
- 退勤時刻: `18:00`
- 休憩時間: 60分

**計算**:

1. **実労働時間の計算**
   ```
   実労働時間 = 10:00 から 18:00 まで = 8時間 = 480分
   休憩時間 = 60分
   実労働時間（休憩除く）= 480 - 60 = 420分 = 7時間
   ```

2. **給与の計算**
   ```
   給与 = 1,200 × 7 = 8,400円
   ```

---

## 8. UI表示

給与明細のプレビュー画面に、以下の説明を追記します：

```
労働時間: 08:45-18:14
残業時間: 05:00-08:44、18:15-21:59
深夜時間: 22:00-04:59
```

---

## 9. エッジケース

### 9.1 連続勤務が24時間を超える場合

- システム上ではエラーを出さない
- 実務でフォローする

### 9.2 複数時間帯にまたがる場合

- 時間帯ごとに分けて計算する必要がある
- 例: `18:10-22:30`の場合
  - `18:10-18:15`（5分）: 通常時間帯（残業対象外）
  - `18:16-21:59`（223分）: `18:16-21:59`時間帯（1.25倍）
  - `22:00-22:30`（30分）: `22:00-04:59`時間帯（1.50倍）

### 9.3 日をまたぐ場合

- `22:00-04:59`の時間帯は開始日の時間帯として扱う
- 例: `2025-12-15 23:00` から `2025-12-16 03:00` は `2025-12-15`（月曜日）の時間帯として扱う

---

## 10. データモデル

### 10.1 残業代計算結果

給与明細の詳細情報に、以下のフィールドを追加します：

```typescript
interface OvertimeCalculation {
  // 時間帯別の残業時間（分単位）
  overtimeByTimeSlot: {
    "05:00-08:44": number;      // 平日・土曜: 1.25倍、日曜: 1.50倍
    "18:16-21:59": number;      // 1.25倍（全曜日）
    "22:00-04:59": number;      // 1.50倍（全曜日）
  };
  
  // 時間帯別の残業代（円単位、切り上げ済み）
  overtimeAllowanceByTimeSlot: {
    "05:00-08:44": number;
    "18:16-21:59": number;
    "22:00-04:59": number;
  };
  
  // 残業単価（正社員の場合のみ）
  overtimeRate?: number;        // 円/時間
  
  // 合計残業代
  totalOvertimeAllowance: number;  // 円単位、切り上げ済み
}
```

詳細は[API_SPEC_PAYROLL.md](./API_SPEC_PAYROLL.md)のデータモデルを参照してください。

---

## 11. API設計

### 11.1 残業代計算API

残業代の計算は、給与明細作成時に自動的に計算されます。
必要に応じて、以下のAPIエンドポイントを実装することができます：

**エンドポイント**: `POST /api/v1/payroll/calculate-overtime`

**リクエストボディ**:
```json
{
  "employeeId": "emp001",
  "startDateTime": "2025-12-15T09:00:00Z",
  "endDateTime": "2025-12-15T20:30:00Z",
  "breakMinutes": 90,
  "workDate": "2025-12-15"
}
```

**レスポンス**:
```json
{
  "overtimeByTimeSlot": {
    "05:00-08:44": 0,
    "18:16-21:59": 134,
    "22:00-04:59": 0
  },
  "overtimeAllowanceByTimeSlot": {
    "05:00-08:44": 0,
    "18:16-21:59": 43542,
    "22:00-04:59": 0
  },
  "overtimeRate": 15610,
  "totalOvertimeAllowance": 43542,
  "totalWorkMinutes": 600,
  "prescribedWorkMinutes": 450,
  "overtimeMinutes": 150
}
```

詳細は[API_SPEC_PAYROLL.md](./API_SPEC_PAYROLL.md)を参照してください。

---

## 12. 実装時の注意事項

1. **時刻の扱い**: 全てAPI側で計算する（クライアント側の時刻の誤差を防ぐため）
2. **端数処理**: 金額端数は全て切り上げ（1円単位）
3. **時間帯の境界値**: 開始時刻を含み、終了時刻を含まない `[開始時刻, 終了時刻)`
4. **日付変更時刻**: `05:00`で日付が変わる
5. **曜日判定**: 開始日の曜日を使用（祝日は稼働日として扱う）
6. **休憩時間**: 残業時間から除外する
7. **所定労働時間**: 正社員は7.5時間/日、パートは個人ごとに異なる
8. **通常時間帯**: `08:45-18:15`は残業判定の対象外（通常単価として扱う）

---

## 13. 関連ドキュメント

- [API_SPEC_PAYROLL.md](./API_SPEC_PAYROLL.md): 給与明細API仕様書
- [API_SPEC_EMPLOYEES.md](./API_SPEC_EMPLOYEES.md): 従業員API仕様書
- [API_SPEC_ATTENDANCE.md](./API_SPEC_ATTENDANCE.md): 勤怠API仕様書
- [API_SPEC_ALLOWANCES.md](./API_SPEC_ALLOWANCES.md): 手当マスタAPI仕様書







